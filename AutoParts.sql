Drop TABLE USUARIOS CASCADE CONSTRAINTS;
Drop TABLE SUCURSALES CASCADE CONSTRAINTS;
Drop TABLE PRODUCTOS CASCADE CONSTRAINTS;
Drop TABLE INVENTARIO CASCADE CONSTRAINTS;
Drop TABLE DETALLE_PEDIDO CASCADE CONSTRAINTS;
Drop TABLE PEDIDOS CASCADE CONSTRAINTS; 
Drop TABLE PAGOS CASCADE CONSTRAINTS;
Drop TABLE BITACORA CASCADE CONSTRAINTS;
Drop TABLE CARRITOS CASCADE CONSTRAINTS;
Drop TABLE CARRITO_PRODUCTOS CASCADE CONSTRAINTS;


CREATE TABLE USUARIOS (
    ID_USUARIO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    RUT VARCHAR2(12) UNIQUE NOT NULL,
    NOMBRE_COMPLETO VARCHAR2(100) NOT NULL,
    CORREO VARCHAR2(100) UNIQUE NOT NULL,
    CONTRASENA VARCHAR2(100) NOT NULL,
    ROL VARCHAR2(20) CHECK (ROL IN ('CLIENTE', 'DISTRIBUIDOR', 'TALLER', 'ADMIN')),
    FECHA_REGISTRO DATE DEFAULT SYSDATE
);

CREATE TABLE SUCURSALES (
    ID_SUCURSAL NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(100) NOT NULL,
    DIRECCION VARCHAR2(150),
    COMUNA VARCHAR2(50),
    REGION VARCHAR2(50)
);

CREATE TABLE PRODUCTOS (
    ID_PRODUCTO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(100) NOT NULL,
    DESCRIPCION VARCHAR2(255),
    MARCA VARCHAR2(50),
    PRECIO_UNITARIO NUMBER(10, 2) NOT NULL,
    STOCK_MIN NUMBER DEFAULT 0
);

CREATE TABLE INVENTARIO (
    ID_INVENTARIO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_SUCURSAL NUMBER NOT NULL,
    ID_PRODUCTO NUMBER NOT NULL,
    STOCK NUMBER DEFAULT 0,
    CONSTRAINT FK_INVENTARIO_SUCURSAL FOREIGN KEY (ID_SUCURSAL) REFERENCES SUCURSALES(ID_SUCURSAL),
    CONSTRAINT FK_INVENTARIO_PRODUCTO FOREIGN KEY (ID_PRODUCTO) REFERENCES PRODUCTOS(ID_PRODUCTO),
    CONSTRAINT UC_SUCURSAL_PRODUCTO UNIQUE (ID_SUCURSAL, ID_PRODUCTO)
);


CREATE TABLE DETALLE_PEDIDO (
    ID_DETALLE NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_carrito NUMBER NOT NULL,
    DIRECCION VARCHAR (150) NOT NULL,
    CONSTRAINT FK_DETALLE_PEDIDO FOREIGN KEY (ID_CARRITO) REFERENCES CARRITOS(ID_CARRITO)
);

CREATE TABLE PEDIDOS (
    ID_PEDIDO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER,
    FECHA_PEDIDO DATE DEFAULT SYSDATE,
    ID_DETALLE NUMBER NOT NULL,
    TIPO_PEDIDO VARCHAR2(10) CHECK (TIPO_PEDIDO IN ('B2B', 'B2C')),
    CONSTRAINT FK_PEDIDO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO),
     CONSTRAINT FK_DETALLE_USUARIO FOREIGN KEY (ID_DETALLE) REFERENCES DETALLE_PEDIDO(ID_DETALLE)
);

CREATE TABLE PAGOS (
    ID_PAGO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_PEDIDO NUMBER NOT NULL,
    MONTO_TOTAL NUMBER(10,2),
    METODO_PAGO VARCHAR2(30) CHECK (METODO_PAGO IN ('WEBPAY', 'MERCADOPAGO', 'TRANSFERENCIA')),
    ESTADO_PAGO VARCHAR2(20) CHECK (ESTADO_PAGO IN ('PENDIENTE', 'PAGADO', 'FALLIDO')),
    FECHA_PAGO DATE DEFAULT SYSDATE,
    CONSTRAINT FK_PAGO_PEDIDO FOREIGN KEY (ID_PEDIDO) REFERENCES PEDIDOS(ID_PEDIDO)
);

CREATE TABLE BITACORA (
    ID_LOG NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER NOT NULL,
    ACCION VARCHAR2(255),
    FECHA_ACCION DATE DEFAULT SYSDATE,
    CONSTRAINT FK_BITACORA_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO)
);

CREATE TABLE CARRITOS (
    ID_CARRITO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    FECHA_CREACION DATE DEFAULT SYSDATE
);

CREATE TABLE CARRITO_PRODUCTOS (
    ID_CARRITO NUMBER NOT NULL,
    ID_PRODUCTO NUMBER NOT NULL,
    CANTIDAD NUMBER NOT NULL,
    VALOR_UNITARIO NUMBER(10, 2) NOT NULL,
    VALOR_TOTAL NUMBER(10, 2) NOT NULL,
    PRIMARY KEY (ID_CARRITO, ID_PRODUCTO),
    CONSTRAINT FK_CARRITO_PRODUCTO_CARRITO FOREIGN KEY (ID_CARRITO) REFERENCES CARRITOS(ID_CARRITO),
    CONSTRAINT FK_CARRITO_PRODUCTO_PRODUCTO FOREIGN KEY (ID_PRODUCTO) REFERENCES PRODUCTOS(ID_PRODUCTO)
);


-- USUARIOS
INSERT INTO USUARIOS VALUES (1, '11111111-1', 'Juan Pérez', 'juanperez@mail.com', 'pass123', 'CLIENTE', SYSDATE);
INSERT INTO USUARIOS VALUES (2, '22222222-2', 'María López', 'marialopez@mail.com', 'pass456', 'DISTRIBUIDOR', SYSDATE);
INSERT INTO USUARIOS VALUES (3, '33333333-3', 'Carlos Soto', 'carlossoto@mail.com', 'pass789', 'ADMIN', SYSDATE);

-- SUCURSALES
INSERT INTO SUCURSALES VALUES (1, 'Sucursal Santiago', 'Av. Providencia 123', 'Providencia', 'RM');
INSERT INTO SUCURSALES VALUES (2, 'Sucursal Valparaíso', 'Calle Prat 456', 'Valparaíso', 'V Región');

-- PRODUCTOS
INSERT INTO PRODUCTOS VALUES (1, 'Filtro de Aceite', 'Filtro para motor gasolina', 'Bosch', 4990, 50);
INSERT INTO PRODUCTOS VALUES (2, 'Bujía', 'Bujía estándar NGK', 'NGK', 2990, 50);
INSERT INTO PRODUCTOS VALUES (3, 'Amortiguador', 'Amortiguador delantero', 'Monroe', 19990, 50);
INSERT INTO PRODUCTOS VALUES (4, 'Frenos', 'Juego de frenos delanteros', 'Brembo', 5990, 50);
INSERT INTO PRODUCTOS VALUES (5, 'Aceite Motor', 'Aceite sintético 5W30', 'Mobil', 10990, 50);
INSERT INTO PRODUCTOS VALUES (6, 'Batería', 'Batería de 12V', 'Varta', 59990, 50);
INSERT INTO PRODUCTOS VALUES (7, 'Neumático', 'Neumático 205/55 R16', 'Michelin', 49990, 50);

-- INVENTARIO
INSERT INTO INVENTARIO VALUES (1, 1, 1, 50);
INSERT INTO INVENTARIO VALUES (2, 1, 2, 90);
INSERT INTO INVENTARIO VALUES (3, 1, 3, 40);
INSERT INTO INVENTARIO VALUES (4, 1, 4, 30);
INSERT INTO INVENTARIO VALUES (5, 1, 5, 100);
INSERT INTO INVENTARIO VALUES (6, 1, 6, 10);
INSERT INTO INVENTARIO VALUES (7, 1, 7, 500);
INSERT INTO INVENTARIO VALUES (8, 2, 7, 20);

-- PEDIDOS
INSERT INTO PEDIDOS VALUES (1, 1, SYSDATE, 'PENDIENTE', 'B2C');
INSERT INTO PEDIDOS VALUES (2, 2, SYSDATE, 'CONFIRMADO', 'B2B');

-- DETALLE_PEDIDO
INSERT INTO DETALLE_PEDIDO VALUES (1, 1, 1, 2, 4990);
INSERT INTO DETALLE_PEDIDO VALUES (2, 1, 2, 4, 2990);
INSERT INTO DETALLE_PEDIDO VALUES (3, 2, 3, 3, 19990);

-- PAGOS
INSERT INTO PAGOS VALUES (1, 1, 18940, 'WEBPAY', 'PAGADO', SYSDATE);
INSERT INTO PAGOS VALUES (2, 2, 59970, 'TRANSFERENCIA', 'PENDIENTE', SYSDATE);

-- BITACORA
INSERT INTO BITACORA VALUES (1, 1, 'Inicio de sesión', SYSDATE);
INSERT INTO BITACORA VALUES (2, 2, 'Generó un pedido', SYSDATE);
INSERT INTO BITACORA VALUES (3, 3, 'Actualizó precios de productos', SYSDATE);

-- CARRITO
INSERT INTO CARRITOS VALUES (1, SYSDATE);
INSERT INTO CARRITO_PRODUCTOS VALUES (1, 1, 2, 4990, 9880);

COMMIT;
