-- Eliminación de tablas con sus restricciones
DROP TABLE PAGOS CASCADE CONSTRAINTS;
DROP TABLE PEDIDOS CASCADE CONSTRAINTS;
DROP TABLE DETALLE_PEDIDO CASCADE CONSTRAINTS;
DROP TABLE CARRITO_PRODUCTOS CASCADE CONSTRAINTS;
DROP TABLE CARRITOS CASCADE CONSTRAINTS;
DROP TABLE BITACORA CASCADE CONSTRAINTS;
DROP TABLE INVENTARIO CASCADE CONSTRAINTS;
DROP TABLE HISTORICO_PRECIOS CASCADE CONSTRAINTS;
DROP TABLE PRODUCTOS CASCADE CONSTRAINTS;
DROP TABLE SUBCATEGORIAS CASCADE CONSTRAINTS;
DROP TABLE CATEGORIAS CASCADE CONSTRAINTS;
DROP TABLE SUCURSALES CASCADE CONSTRAINTS;
DROP TABLE USUARIOS CASCADE CONSTRAINTS;

-- USUARIOS
CREATE TABLE USUARIOS (
    ID_USUARIO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    RUT VARCHAR2(12) UNIQUE NOT NULL,
    NOMBRE_COMPLETO VARCHAR2(100) NOT NULL,
    CORREO VARCHAR2(100) UNIQUE NOT NULL,
    CONTRASENA VARCHAR2(100) NOT NULL,
    ROL VARCHAR2(20) CHECK (ROL IN ('CLIENTE', 'DISTRIBUIDOR', 'TALLER', 'ADMIN')),
    FECHA_REGISTRO DATE DEFAULT SYSDATE
);

-- SUCURSALES
CREATE TABLE SUCURSALES (
    ID_SUCURSAL NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(100) NOT NULL,
    DIRECCION VARCHAR2(150),
    COMUNA VARCHAR2(50),
    REGION VARCHAR2(50)
);

-- Tabla de categorías de productos
CREATE TABLE CATEGORIAS (
    ID_CATEGORIA NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(100) NOT NULL UNIQUE
);

-- Tabla de subcategorías
CREATE TABLE SUBCATEGORIAS (
    ID_SUBCATEGORIA NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_CATEGORIA NUMBER NOT NULL,
    NOMBRE VARCHAR2(100) NOT NULL,
    CONSTRAINT FK_SUBCAT_CATEGORIA FOREIGN KEY (ID_CATEGORIA) REFERENCES CATEGORIAS(ID_CATEGORIA)
);

-- PRODUCTOS
CREATE TABLE PRODUCTOS (
    ID_PRODUCTO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    CODIGO_FABRICANTE VARCHAR2(20),
    MARCA VARCHAR2(50),
    CODIGO_INTERNO VARCHAR2(20),
    NOMBRE VARCHAR2(100) NOT NULL,
    DESCRIPCION VARCHAR2(255),
    PRECIO_UNITARIO NUMBER(10, 2) NOT NULL,
    STOCK_MIN NUMBER DEFAULT 0,
    ID_CATEGORIA NUMBER NOT NULL,
    CONSTRAINT FK_PRODUCTO_CATEGORIA FOREIGN KEY (ID_CATEGORIA) REFERENCES CATEGORIAS(ID_CATEGORIA)
);

-- HISTORICO_PRECIOS
CREATE TABLE HISTORICO_PRECIOS (
    ID_PRECIO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_PRODUCTO NUMBER NOT NULL,
    FECHA_CAMBIO DATE DEFAULT SYSDATE,
    VALOR NUMBER(10,2) NOT NULL,
    CONSTRAINT FK_PRECIO_PRODUCTO FOREIGN KEY (ID_PRODUCTO) REFERENCES PRODUCTOS(ID_PRODUCTO)
);

-- INVENTARIO
CREATE TABLE INVENTARIO (
    ID_INVENTARIO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_SUCURSAL NUMBER NOT NULL,
    ID_PRODUCTO NUMBER NOT NULL,
    STOCK NUMBER DEFAULT 0,
    CONSTRAINT FK_INVENTARIO_SUCURSAL FOREIGN KEY (ID_SUCURSAL) REFERENCES SUCURSALES(ID_SUCURSAL),
    CONSTRAINT FK_INVENTARIO_PRODUCTO FOREIGN KEY (ID_PRODUCTO) REFERENCES PRODUCTOS(ID_PRODUCTO),
    CONSTRAINT UC_SUCURSAL_PRODUCTO UNIQUE (ID_SUCURSAL, ID_PRODUCTO)
);

-- CARRITOS
CREATE TABLE CARRITOS (
    ID_CARRITO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    FECHA_CREACION DATE DEFAULT SYSDATE
);

-- CARRITO_PRODUCTOS
CREATE TABLE CARRITO_PRODUCTOS (
    ID_CARRITO NUMBER NOT NULL,
    ID_PRODUCTO NUMBER NOT NULL,
    CANTIDAD NUMBER NOT NULL,
    VALOR_UNITARIO NUMBER(10, 2) NOT NULL,
    VALOR_TOTAL NUMBER(10, 2) NOT NULL,
    PRIMARY KEY (ID_CARRITO, ID_PRODUCTO),
    CONSTRAINT FK_CARRITO_PRODUCTO_CARRITO FOREIGN KEY (ID_CARRITO) REFERENCES CARRITOS(ID_CARRITO),
    CONSTRAINT FK_CARRITO_PRODUCTO_PRODUCTO FOREIGN KEY (ID_PRODUCTO) REFERENCES PRODUCTOS(ID_PRODUCTO)
);

-- DETALLE_PEDIDO
CREATE TABLE DETALLE_PEDIDO (
    ID_DETALLE NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_CARRITO NUMBER NOT NULL,
    DIRECCION VARCHAR (150) NOT NULL,
    CONSTRAINT FK_DETALLE_PEDIDO FOREIGN KEY (ID_CARRITO) REFERENCES CARRITOS(ID_CARRITO)
);

-- PEDIDOS
CREATE TABLE PEDIDOS (
    ID_PEDIDO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER,
    FECHA_PEDIDO DATE DEFAULT SYSDATE,
    ID_DETALLE NUMBER NOT NULL,
    TIPO_PEDIDO VARCHAR2(10) CHECK (TIPO_PEDIDO IN ('B2B', 'B2C')),
    CONSTRAINT FK_PEDIDO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO),
    CONSTRAINT FK_DETALLE_USUARIO FOREIGN KEY (ID_DETALLE) REFERENCES DETALLE_PEDIDO(ID_DETALLE)
);

-- PAGOS
CREATE TABLE PAGOS (
    ID_PAGO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_PEDIDO NUMBER NOT NULL,
    MONTO_TOTAL NUMBER(10,2),
    METODO_PAGO VARCHAR2(30) CHECK (METODO_PAGO IN ('WEBPAY', 'MERCADOPAGO', 'TRANSFERENCIA')),
    ESTADO_PAGO VARCHAR2(20) CHECK (ESTADO_PAGO IN ('PENDIENTE', 'PAGADO', 'FALLIDO')),
    FECHA_PAGO DATE DEFAULT SYSDATE,
    CONSTRAINT FK_PAGO_PEDIDO FOREIGN KEY (ID_PEDIDO) REFERENCES PEDIDOS(ID_PEDIDO)
);

-- BITACORA
CREATE TABLE BITACORA (
    ID_LOG NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER NOT NULL,
    ACCION VARCHAR2(255),
    FECHA_ACCION DATE DEFAULT SYSDATE,
    CONSTRAINT FK_BITACORA_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO)
);

