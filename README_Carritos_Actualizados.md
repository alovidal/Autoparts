# API de Carritos Actualizada

## Nueva Estructura de Carritos

La API ahora soporta una relación más flexible donde:
- **Usuarios registrados** pueden tener múltiples carritos
- **Invitados** pueden tener un carrito asociado al localStorage (session_id)
- Los carritos tienen estados y fechas de actividad para mejor gestión

## Cambios en la Base de Datos

### Tabla CARRITOS (Actualizada)
```sql
CREATE TABLE CARRITOS (
    ID_CARRITO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER NULL, -- NULL para carritos de invitados
    SESSION_ID VARCHAR2(100) NULL, -- Para identificar carritos de invitados
    NOMBRE_CARRITO VARCHAR2(100) DEFAULT 'Carrito Principal',
    ESTADO VARCHAR2(20) DEFAULT 'ACTIVO' CHECK (ESTADO IN ('ACTIVO', 'CONVERTIDO', 'ELIMINADO')),
    FECHA_CREACION DATE DEFAULT SYSDATE,
    FECHA_ULTIMA_ACTIVIDAD DATE DEFAULT SYSDATE,
    CONSTRAINT FK_CARRITO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO),
    CONSTRAINT CK_CARRITO_TIPO CHECK (
        (ID_USUARIO IS NOT NULL AND SESSION_ID IS NULL) OR 
        (ID_USUARIO IS NULL AND SESSION_ID IS NOT NULL)
    )
);
```

### Tabla CARRITO_PRODUCTOS (Actualizada)
```sql
CREATE TABLE CARRITO_PRODUCTOS (
    ID_CARRITO NUMBER NOT NULL,
    ID_PRODUCTO NUMBER NOT NULL,
    ID_SUCURSAL NUMBER NOT NULL, 
    CANTIDAD NUMBER NOT NULL,
    VALOR_UNITARIO NUMBER(10, 2) NOT NULL,
    VALOR_TOTAL NUMBER(10, 2) NOT NULL,
    FECHA_AGREGADO DATE DEFAULT SYSDATE, -- Nueva columna
    PRIMARY KEY (ID_CARRITO, ID_PRODUCTO),
    -- ... constraints
);
```

## Nuevos Endpoints

### 1. Crear Carrito
**POST** `/carritos`

Crea un carrito para usuario registrado o invitado.

**Body:**
```json
{
    "id_usuario": 1,           // OPCIONAL - para usuarios registrados
    "session_id": "abc123",    // OPCIONAL - para invitados
    "nombre_carrito": "Mi Carrito"  // OPCIONAL - default: "Carrito Principal"
}
```

**Respuesta:**
```json
{
    "id_carrito": 1,
    "mensaje": "Carrito creado correctamente",
    "tipo": "usuario"  // o "invitado"
}
```

### 2. Obtener Carritos de Usuario
**GET** `/carritos/usuario/{id_usuario}`

Obtiene todos los carritos activos de un usuario registrado.

**Respuesta:**
```json
{
    "carritos": [
        {
            "id_carrito": 1,
            "nombre_carrito": "Carrito Principal",
            "estado": "ACTIVO",
            "fecha_creacion": "2024-01-15T10:30:00",
            "fecha_ultima_actividad": "2024-01-15T14:20:00",
            "num_productos": 3,
            "total_carrito": 133000
        }
    ]
}
```

### 3. Obtener Carrito de Invitado
**GET** `/carritos/session/{session_id}`

Obtiene el carrito de un invitado por su session_id.

**Respuesta:**
```json
{
    "id_carrito": 2,
    "nombre_carrito": "Carrito Invitado",
    "estado": "ACTIVO",
    "fecha_creacion": "2024-01-15T11:00:00",
    "fecha_ultima_actividad": "2024-01-15T12:30:00",
    "num_productos": 2,
    "total_carrito": 130000
}
```

### 4. Actualizar Actividad del Carrito
**PUT** `/carritos/{id_carrito}/actualizar_actividad`

Actualiza la fecha de última actividad del carrito.

### 5. Convertir Carrito de Invitado
**POST** `/carritos/{id_carrito}/convertir/{id_usuario}`

Convierte un carrito de invitado a carrito de usuario registrado.

**Respuesta:**
```json
{
    "mensaje": "Carrito convertido exitosamente"
}
```

### 6. Listar Productos del Carrito (Mejorado)
**GET** `/carritos/{id_carrito}/productos`

Ahora incluye información adicional del carrito y totales.

**Respuesta:**
```json
{
    "productos": [
        {
            "id_producto": 1,
            "id_sucursal": 1,
            "cantidad": 2,
            "valor_unitario": 25000,
            "valor_total": 50000,
            "fecha_agregado": "2024-01-15T10:30:00",
            "nombre": "Aceite Mobil 1",
            "marca": "Mobil",
            "imagen": "aceite_mobil.jpg",
            "descripcion": "Aceite sintético 5W-30",
            "sucursal_nombre": "Sucursal Centro"
        }
    ],
    "total_carrito": 133000,
    "num_productos": 3,
    "carrito_info": {
        "id_carrito": 1,
        "estado": "ACTIVO",
        "id_usuario": 1,
        "session_id": null,
        "nombre_carrito": "Carrito Principal"
    }
}
```

### 7. Limpiar Carritos de Invitados Antiguos
**DELETE** `/carritos/limpiar_invitados`

Marca como eliminados los carritos de invitados con más de 30 días de inactividad.

**Respuesta:**
```json
{
    "mensaje": "Se limpiaron 5 carritos de invitados antiguos"
}
```

### 8. Estadísticas de Carritos
**GET** `/carritos/estadisticas`

Obtiene estadísticas generales de carritos.

**Respuesta:**
```json
{
    "tipos_carrito": [
        {"tipo": "USUARIOS_REGISTRADOS", "cantidad": 15},
        {"tipo": "INVITADOS", "cantidad": 8}
    ],
    "total_productos_en_carritos": 45,
    "carritos_con_mas_productos": [
        {
            "id_carrito": 1,
            "nombre_carrito": "Carrito Principal",
            "num_productos": 5,
            "total_valor": 150000
        }
    ]
}
```

## Endpoints Actualizados

### Agregar Producto al Carrito
- Ahora verifica que el carrito esté activo
- Actualiza automáticamente la fecha de última actividad
- Incluye fecha_agregado en los productos

### Actualizar Cantidad
- Verifica stock disponible
- Actualiza fecha de última actividad del carrito
- Actualiza fecha_agregado del producto

### Vaciar Carrito
- Verifica que el carrito esté activo
- Actualiza fecha de última actividad

## Flujo de Uso

### Para Usuarios Registrados:
1. Crear carrito con `id_usuario`
2. Agregar productos al carrito
3. Pueden tener múltiples carritos activos
4. Convertir carritos de invitado al registrarse

### Para Invitados:
1. Crear carrito con `session_id` (generado en frontend)
2. Agregar productos al carrito
3. Al registrarse, convertir el carrito de invitado

### Conversión de Carritos:
- Los carritos de invitado se pueden convertir a carritos de usuario
- Se mantiene toda la información de productos
- El carrito cambia de estado a 'CONVERTIDO'

## Scripts de Migración

1. **actualizar_estructura_carritos.sql** - Actualiza la estructura de la base de datos
2. **datos_prueba_carritos_actualizados.sql** - Inserta datos de prueba

## Beneficios de la Nueva Estructura

- ✅ Múltiples carritos por usuario
- ✅ Carritos de invitados persistentes
- ✅ Conversión automática al registrarse
- ✅ Mejor gestión de estados
- ✅ Limpieza automática de carritos antiguos
- ✅ Estadísticas detalladas
- ✅ Trazabilidad de actividad 